// =====================================
// Prisma schema â€” Engagement Service
// ALL TABLES live in schema: engagement
// =====================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["engagement"]
}

model Account {
  id                String   @id @default(uuid())
  status            String   @default("ACTIVE")
  name              String   @default("My Workspace")
  plan_id           String   @default("FREE")
  onboarding_state  String   @default("CREATED")
  created_at        DateTime @default(now())

  installs           InstallRegistry[]
  events             EngagementEvent[]
  memberships        WorkspaceMembership[]
  active_sessions    Session[]
  owner_settings     OwnerSettings?

  suggestions        Suggestion[]
  decisions          SuggestionDecision[]

  @@schema("engagement")
}

model Suggestion {
  id                        String   @id @default(uuid())
  workspace_id              String
  event_id                  String
  platform                  String
  video_id                  String
  comment_id                String?
  suggested_text            String
  strategy                  String
  confidence                Float
  signals                   String
  owner_settings_snapshot   String
  status                    String   @default("PENDING")
  created_at                DateTime @default(now())
  expires_at                DateTime?
  context_type              String?
  speaker_role              String?
  template_category         String?

  account     Account          @relation(fields: [workspace_id], references: [id])
  event       EngagementEvent  @relation(fields: [event_id], references: [id])
  decisions   SuggestionDecision[]

  automation_eligible        Boolean? @default(false)
  automation_reasons         String?  @default("[]")
  automation_checked_at      DateTime?

  @@schema("engagement")
}

model SuggestionDecision {
  id            String   @id @default(uuid())
  suggestion_id String
  workspace_id  String
  user_id       String
  decision      String
  final_text    String?
  reason        String?
  created_at    DateTime @default(now())

  suggestion  Suggestion @relation(fields: [suggestion_id], references: [id])
  account     Account    @relation(fields: [workspace_id], references: [id])
  user        User       @relation(fields: [user_id], references: [id])

  @@schema("engagement")
}

model OwnerSettings {
  workspace_id              String   @id
  mode                      String   @default("OBSERVE_ONLY")
  aggressiveness            String   @default("CONSERVATIVE")
  enable_intents            String   @default("{}")
  min_intent_confidence     Float    @default(0.7)
  platforms_enabled         String   @default("[]")
  max_suggestions_per_day   Int      @default(20)
  automation_opt_in         Boolean  @default(false)
  max_suggestions_per_video Int      @default(2)
  cooldown_hours            Int      @default(24)
  preferred_language        String?
  tone                      String?
  created_at                DateTime @default(now())
  updated_at                DateTime @updatedAt

  account Account @relation(fields: [workspace_id], references: [id])

  @@schema("engagement")
}

model InstallRegistry {
  id             String   @id @default(uuid())
  install_id     String   @unique
  install_secret String?
  is_active      Boolean  @default(true)
  created_at     DateTime @default(now())

  account_id String?
  account    Account? @relation(fields: [account_id], references: [id])

  @@schema("engagement")
}

model EngagementEvent {
  id                 String   @id @default(uuid())
  external_event_id  String?  @unique
  dedup_key          String   @unique
  observed_at        DateTime?
  platform           String
  target_id          String   @default("unknown")

  account_id String?
  account    Account? @relation(fields: [account_id], references: [id])
  install_id String?

  video_id     String
  comment_id   String
  content_text String
  metadata     String?
  status       String
  created_at   DateTime @default(now())

  sessions     SuggestionSession[]
  suggestions  Suggestion[]

  @@schema("engagement")
}

model SuggestionSession {
  id              String   @id @default(uuid())
  event_id        String
  version         Int      @default(1)
  input_snapshot  String
  suggestion_text String
  brain_meta      String?
  created_at      DateTime @default(now())

  event    EngagementEvent @relation(fields: [event_id], references: [id])
  feedback FeedbackSignal?

  @@schema("engagement")
}

model FeedbackSignal {
  id             String   @id @default(uuid())
  session_id     String   @unique
  action         String
  final_text     String?
  edit_distance  Int?
  time_to_action Int?
  created_at     DateTime @default(now())

  session SuggestionSession @relation(fields: [session_id], references: [id])

  @@schema("engagement")
}

model User {
  id             String   @id @default(uuid())
  email          String   @unique
  password_hash String
  status         String   @default("ACTIVE")
  created_at     DateTime @default(now())

  login_attempts Int      @default(0)
  locked_until   DateTime?
  last_login_at  DateTime?

  memberships WorkspaceMembership[]
  sessions    Session[]
  decisions   SuggestionDecision[]

  @@schema("engagement")
}

model AdminUser {
  id            String   @id @default(uuid())
  email         String   @unique
  password_hash String
  role          String   @default("SUPERADMIN")
  created_at    DateTime @default(now())

  sessions AdminSession[]

  @@schema("engagement")
}

model AdminSession {
  id         String   @id @default(uuid())
  admin_id  String
  expires_at DateTime
  created_at DateTime @default(now())

  admin AdminUser @relation(fields: [admin_id], references: [id])

  @@schema("engagement")
}

model AuditLog {
  id             String   @id @default(uuid())
  actor_id       String
  actor_type     String
  action         String
  resource       String
  resource_id    String?
  workspace_id   String?
  meta           String?
  ip             String?
  correlation_id String?
  created_at     DateTime @default(now())

  @@index([workspace_id, created_at])
  @@index([actor_id, created_at])
  @@index([correlation_id])
  @@schema("engagement")
}

model WorkspaceMembership {
  id           String   @id @default(uuid())
  workspace_id String
  user_id      String
  role         String   @default("MEMBER")
  status       String   @default("ACTIVE")
  created_at   DateTime @default(now())

  account Account @relation(fields: [workspace_id], references: [id])
  user    User    @relation(fields: [user_id], references: [id])

  @@unique([workspace_id, user_id])
  @@schema("engagement")
}

model Session {
  id                  String   @id @default(uuid())
  user_id             String
  active_workspace_id String?
  expires_at          DateTime
  last_seen_at        DateTime @default(now())
  created_at          DateTime @default(now())

  user             User     @relation(fields: [user_id], references: [id])
  active_workspace Account? @relation(fields: [active_workspace_id], references: [id])

  @@schema("engagement")
}
